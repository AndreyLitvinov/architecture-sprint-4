# Выбор и настройка мониторинга в системе

## Мотивация

1. На данный момент система является черным ящиком, нет возможности определить почему пропадают заказы и в какой части системы. О проблемах команда узнает непосредственно от клиентов, что негативно влияет на бизнес. Нет возможности решить проблему до того как клиент узнает о ней.

2. У бизнеса нет возможности получать аналитику по той части системы которая не покрыта метриками яндекса, необходимо добавить бизнес мониторинг для этой части системы. Без этой информации бизнес может принимать неверные решения.

3. В данный момент нет понимания какие сервисы как стабильно работают и как потребляют ресурсы. Эта информация необходима для правильного распределения ресурсов для сервисов, и анализа необходимости горизонтального масштабирования отдельных частей системы.

## Выбор подхода к мониторингу

### Сервис Онлайн-магазин

**RED метрики:**
- частота, какая частота по разным ендпоинтам
- ошибки, как часто происходят ошибки
- длительность, какие эндпоинты дольше отвечают и когда

Метрики:
- Number of `HTTP 500` for shop API - позволит понять как часто и почему пользователь получает ошибку. *Ярлыки: endpoint, method*
- Number of simultanious sessions for shop API - позволит понять как много пользователей работают в системе одновременно 
- Response time (latency) for shop API - позволит понять как быстро пользователи получают ответ *Ярлыки: endpoint, method*
- Size of shop db instance - позволит предотвратить проблему с недостаточным местом для БД, так же поймать ошибку сильного разрастания БД из-за какого-то функционала

### CRM
Аналогичные метрики как и для онлайн-магазина.

Метрики:
- Number of `HTTP 500` for CRM API - позволит понять как часто и почему пользователь получает ошибку. *Ярлыки: endpoint, method*
- Response time (latency) for CRM API - позволит понять как быстро пользователи получают ответ *Ярлыки: endpoint, method*
- Size of CRM db instance - позволит предотвратить проблему с недостаточным местом для БД, так же поймать ошибку сильного разрастания БД из-за какого-то функционала

### MES
Аналогичные параметры как и для **Онлайн магазина**. 

Метрики:
- Number of `HTTP 500` for MES API - позволит понять как часто и почему пользователь получает ошибку
- Number of simultanious sessions for MES API- позволит понять как много пользователей работают в системе одновременно 
- Response time (latency) for MES API - позволит понять как быстро пользователи получают ответ *Ярлыки: endpoint, method*
- Size of MES db instance - позволит предотвратить проблему с недостаточным местом для БД, так же поймать ошибку сильного разрастания БД из-за какого-то функционала
- CPU % for MES сервиса расчета стоимости - позволит определиться с масштабированием этого сервиса
- Memory Utilisation for MES сервиса расчета стоимости - позволит определиться с масштабированием этого сервиса


Плюс **USE метрики** для отдельного сервиса расчета стоимости:
- утилизация — позволит оценить нагрузку на сервис
- насыщенность — позволит понять как справляется сервис с работай и стоит ли масштабироваться
- ошибки — позволит оценить насколько стабильно работает сервис

### RabbitMQ

Метрики: 
- Number of dead-letter-exchange letters in RabbitMQ - позволит увидеть проблему обработки событий. *Ярлыки: exchange, queue*

### S3

Метрики:
- Size of S3 storage - позволит контролировать размер хранилища, запускать например очистку неактуальных данных или принять решение по шардированию системы


## План действий

1. Внедрение в CI/CD реализации автоматического развертывания Prometheus и Grafana.
2. Внедрение в существующие сервисы инструментов сбора метрик
3. Настройка в Grafana необходимых дашбардов и настройка нотификаций.